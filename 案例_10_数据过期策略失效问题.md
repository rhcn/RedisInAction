# Redis 故障处理实践案例：数据过期策略失效问题

## 一、案例背景
一家在线服务平台使用 Redis 存储用户的临时会话信息和一些短期有效的数据，设置了数据的过期时间，但在日常运营中，发现部分数据过期后仍然存在于 Redis 中，没有被自动删除，导致内存占用异常。


## 二、故障现象
1. 使用 Redis 的 `SCAN` 命令扫描键，发现部分设置了过期时间的数据在过期后仍然存在，没有被删除。
2. Redis 的内存使用情况显示，过期数据占用了大量的内存，影响了其他数据的存储和系统性能。


## 三、故障排查步骤
1. 过期策略检查：
    - 检查 Redis 的 `INFO` 命令输出，查看 `expired_keys` 和 `evicted_keys` 等指标，发现过期键的数量和驱逐键的数量不符合预期。
    - 分析 Redis 的 `maxmemory-policy` 配置，发现配置为 `noeviction`，导致 Redis 在达到内存上限时不会主动驱逐过期数据。


## 四、故障处理措施
1. 调整过期策略：
    - 将 `maxmemory-policy` 配置修改为 `volatile-lru` 或 `allkeys-lru`，使 Redis 在内存不足时可以主动驱逐过期数据或使用 LRU 算法淘汰数据。

```bash
redis-cli CONFIG SET maxmemory-policy volatile-lru
```


## 五、业务验证
1. 在完成上述处理措施后，观察 Redis 的 `INFO` 命令输出，发现过期键会被正常删除，`expired_keys` 指标显示正常。
2. 观察 Redis 的内存使用情况，内存使用趋于正常，过期数据不再占用大量内存。


## 六、故障总结与预防措施
1. 故障总结：
    - 本次故障是由于 Redis 的过期策略配置不当，导致过期数据无法正常清除，影响了内存使用和系统性能。
2. 预防措施：
    - 定期检查 Redis 的 `maxmemory-policy` 配置，根据业务需求和内存使用情况，选择合适的过期策略。
    - 监控 Redis 的内存使用情况，确保过期策略能够有效工作，避免过期数据占用过多内存。
